name: AI Stock Trader - Full Stack Deployment

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '.gitignore'
  pull_request:
    branches: [main, master]

env:
  NODE_VERSION: '18'
  DOCKER_IMAGE_NAME: ai-stock-trader

jobs:
  # 测试阶段 - 确保代码质量
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Install dependencies
      run: |
        cd server && npm ci
        cd .. && npm ci
    
    - name: Run backend tests
      run: |
        cd server
        npm test -- --coverage --watchAll=false
      env:
        NODE_ENV: test
        DATABASE_URL: file:./test.db
        JWT_SECRET: test-secret
        GEMINI_API_KEY: test-key
    
    - name: Build frontend
      run: npm run build
      env:
        VITE_API_URL: http://localhost:3000

  # 部署阶段 - 仅当测试通过后执行
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    environment:
      name: production
      url: http://${{ secrets.SERVER_HOST }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Build frontend
      run: npm run build
      env:
        VITE_API_URL: http://${{ secrets.SERVER_HOST }}:3000
    
    - name: Deploy full stack
      run: |
        echo "=== 开始全栈部署流程 ==="
        
        # 创建部署包
        tar --exclude='node_modules' --exclude='.git' --exclude='dist' --exclude='build' -czf stock-trader.tar.gz .
        
        # 传输到服务器
        scp -i ~/.ssh/id_rsa stock-trader.tar.gz root@${{ secrets.SERVER_HOST }}:/root/
        
        # 执行部署脚本
        ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          echo "=== 服务器端部署开始 ==="
          
          cd /root
          
          # 备份现有部署
          if [ -d "stock-trader" ]; then
            echo "备份现有部署..."
            tar -czf stock-trader-backup-$(date +%Y%m%d-%H%M%S).tar.gz stock-trader
          fi
          
          # 清理并准备新部署
          rm -rf stock-trader
          mkdir -p stock-trader
          tar -xzf stock-trader.tar.gz -C stock-trader
          rm stock-trader.tar.gz
          
          cd stock-trader
          
          # 部署前端静态资源
          echo "部署前端静态资源..."
          mkdir -p /var/www/ai-stock-trader
          cp -r dist/* /var/www/ai-stock-trader/
          
          # 部署后端服务
          echo "部署后端服务..."
          cd server
          
          # 创建生产环境配置文件
          cat > .env.production << ENV_EOF
NODE_ENV=production
DATABASE_URL=${{ secrets.DATABASE_URL }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
PORT=3000
ENV_EOF
          
          # 停止并删除旧容器
          docker stop stock-trader-app || true
          docker rm stock-trader-app || true
          
          # 构建新镜像
          docker build -t ${{ env.DOCKER_IMAGE_NAME }} .
          
          # 运行新容器
          docker run -d \
            --name stock-trader-app \
            -p 3000:3000 \
            --env-file .env.production \
            ${{ env.DOCKER_IMAGE_NAME }}
          
          echo "✓ 后端服务部署完成"
        EOF
        
        echo "=== 部署流程完成 ==="
    
    - name: Health check
      run: |
        echo "执行健康检查..."
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "健康检查尝试 $attempt/$max_attempts"
          
          # 检查后端API
          if curl -f http://${{ secrets.SERVER_HOST }}:3000/api/health > /dev/null 2>&1; then
            echo "✓ 后端API健康检查通过"
            break
          fi
          
          if [ $attempt -eq $max_attempts ]; then
            echo "✗ 健康检查失败"
            exit 1
          fi
          
          sleep 10
          attempt=$((attempt + 1))
        done
        
        echo "✓ 所有健康检查通过"

  # 通知阶段 - 部署结果通知
  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "✅ 部署成功！应用地址: http://${{ secrets.SERVER_HOST }}"
        else
          echo "❌ 部署失败！请检查日志"
        fi